{% extends 'base.html' %}

{% block content %}
<style>
    .recipe-form-card .form-input,
    .recipe-form-card .ingredient-dropdown-button {
        border-color: #071B26;
    }
    .recipe-form-card .form-input:focus,
    .recipe-form-card .ingredient-dropdown-button:focus {
        border-color: #071B26;
        box-shadow: 0 0 0 3px rgba(7, 27, 38, 0.2);
    }
</style>
<div class="max-w-4xl mx-auto">
    <div class="mb-8 border-b border-gray-200 pb-4" style="border-color: #58A7A6;">
        <h2 class="text-3xl font-bold text-brand-dark">{{ title }}</h2>
        <p class="text-gray-500">Define the ingredients and quantities for this dish.</p>
    </div>
    
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 recipe-form-card" style="border-color: #58A7A6;">
        <form method="POST" id="recipe-form">
            {% csrf_token %}
            
            <div class="mb-8 grid grid-cols-1 gap-6">
                <div>
                    <label class="block text-brand-dark font-bold mb-2">Recipe Name</label>
                    {{ form.name }} 
                </div>
                <div>
                    <label class="block text-brand-dark font-bold mb-2">Instructions</label>
                    {{ form.instructions }}
                </div>
            </div>

            <div class="flex justify-between items-end mb-4 border-b pb-2" style="border-color: #58A7A6;">
                <h3 class="text-xl font-bold text-brand-dark"><i class="fa-solid fa-carrot text-brand-teal mr-2"></i>Ingredients</h3>
                <button type="button" id="add-ingredient-btn" class="text-sm bg-brand-light text-brand-teal border border-brand-teal font-bold py-1 px-3 rounded hover:bg-brand-teal hover:text-white transition">
                    + Add Ingredient
                </button>
            </div>

            {{ formset.management_form }}

            <div class="ingredient-table-wrapper mb-8">
                <table class="w-full text-left" id="ingredient-table">
                    <thead class="bg-gray-50 text-sm uppercase" style="color: #58A7A6;">
                        <tr>
                            <th class="p-3 w-1/2">Ingredient</th>
                            <th class="p-3 w-1/6">Unit</th>
                            <th class="p-3 w-1/6">Cost per unit</th>
                            <th class="p-3 w-1/4">Quantity</th>
                            <th class="p-3 w-1/6">Total cost</th>
                            <th class="p-3 text-center w-1/12">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="formset-container">
                        {% for form in formset %}
                            <tr class="ingredient-row group">
                                <td class="p-3 ingredient-dropdown-cell">
                                    <div class="ingredient-dropdown-container" data-ingredient-dropdown>
                                        <input type="hidden"
                                               name="{{ form.ingredient.html_name }}"
                                               id="{{ form.ingredient.id_for_label }}"
                                               value="{{ form.ingredient.value|default_if_none:'' }}">
                                        {{ form.ingredient_name }}
                                        {{ form.ingredient_unit }}
                                        <button type="button" class="ingredient-dropdown-button" data-ingredient-dropdown-button>
                                            <span data-ingredient-selected-label>Select ingredient</span>
                                            <i class="fa-solid fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div class="ingredient-dropdown-menu hidden" data-ingredient-dropdown-menu>
                                            <button type="button" class="ingredient-dropdown-action" data-ingredient-missing-trigger>
                                                + Add missing ingredient
                                            </button>
                                            <div class="ingredient-dropdown-list" data-ingredient-options>
                                                {% for ingredient in ingredients %}
                                                    <div class="ingredient-dropdown-item">
                                                        <button type="button"
                                                                class="ingredient-dropdown-option"
                                                                data-ingredient-option
                                                                data-ingredient-id="{{ ingredient.id }}"
                                                                data-ingredient-name="{{ ingredient.name|escapejs }}"
                                                                data-ingredient-unit="{{ ingredient.unit.name|escapejs }}"
                                                                data-ingredient-cost="{{ ingredient.cost_per_unit.amount }}">
                                                            {{ ingredient.name }}
                                                        </button>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% if form.instance.pk %}{{ form.id }}{% endif %}
                                </td>
                                <td class="p-3 text-sm text-gray-600">
                                    <span data-ingredient-unit-display>--</span>
                                </td>
                                <td class="p-3 text-sm text-gray-600">
                                    <span data-ingredient-cost-display>--</span>
                                </td>
                                <td class="p-3">{{ form.quantity }}</td>
                                <td class="p-3 text-sm text-gray-600">
                                    <span data-ingredient-total-cost-display>--</span>
                                </td>
                                <td class="p-3 text-center space-x-2">
                                    <div class="hidden">{{ form.DELETE }}</div>
                                    <button type="button" class="edit-row-btn text-gray-400 hover:text-brand-teal transition" title="Edit">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <button type="button" class="remove-row-btn text-gray-400 hover:text-red-500 transition">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-4 pt-4 border-t border-gray-100" style="border-color: #58A7A6;">
                <a href="{% url 'chef_dashboard' %}" class="px-6 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-bold transition">Cancel</a>
                <button type="submit" class="btn-save-primary text-white px-8 py-2 rounded-lg font-bold shadow-md transition transform hover:-translate-y-0.5" style="background-color: #58A7A6 !important;">
                    Save Recipe
                </button>
            </div>
        </form>
    </div>
</div>

<div id="empty-form" class="hidden">
    <table>
        <tr class="ingredient-row group">
            <td class="p-3 ingredient-dropdown-cell">
                <div class="ingredient-dropdown-container" data-ingredient-dropdown>
                    <input type="hidden"
                           name="{{ formset.empty_form.ingredient.html_name }}"
                           id="{{ formset.empty_form.ingredient.id_for_label }}"
                           value="">
                    {{ formset.empty_form.ingredient_name }}
                    {{ formset.empty_form.ingredient_unit }}
                    <button type="button" class="ingredient-dropdown-button" data-ingredient-dropdown-button>
                        <span data-ingredient-selected-label>Select ingredient</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div class="ingredient-dropdown-menu hidden" data-ingredient-dropdown-menu>
                        <button type="button" class="ingredient-dropdown-action" data-ingredient-missing-trigger>
                            + Add missing ingredient
                        </button>
                        <div class="ingredient-dropdown-list" data-ingredient-options>
                            {% for ingredient in ingredients %}
                                <div class="ingredient-dropdown-item">
                                    <button type="button"
                                            class="ingredient-dropdown-option"
                                            data-ingredient-option
                                            data-ingredient-id="{{ ingredient.id }}"
                                            data-ingredient-name="{{ ingredient.name|escapejs }}"
                                            data-ingredient-unit="{{ ingredient.unit.name|escapejs }}"
                                            data-ingredient-cost="{{ ingredient.cost_per_unit.amount }}">
                                        {{ ingredient.name }}
                                    </button>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-3 text-sm text-gray-600">
                <span data-ingredient-unit-display>--</span>
            </td>
            <td class="p-3 text-sm text-gray-600">
                <span data-ingredient-cost-display>--</span>
            </td>
            <td class="p-3">
                {{ formset.empty_form.quantity }}
            </td>
            <td class="p-3 text-sm text-gray-600">
                <span data-ingredient-total-cost-display>--</span>
            </td>
            <td class="p-3 text-center space-x-2">
                <div class="hidden">{{ formset.empty_form.DELETE }}</div>
                <button type="button" class="edit-row-btn text-gray-400 hover:text-brand-teal transition" title="Edit">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button type="button" class="remove-row-btn text-gray-400 hover:text-red-500 transition">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        </tr>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const recipeForm = document.getElementById('recipe-form');
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-ingredient-btn');
        const totalForms = document.getElementById('id_recipe_ingredients-TOTAL_FORMS');
        const emptyFormHtml = document.getElementById('empty-form').querySelector('tr').outerHTML;

        function updateIngredientDropdownLabel(container) {
            const hiddenId = container.querySelector('input[name$="ingredient"]');
            const label = container.querySelector('[data-ingredient-selected-label]');
            const hiddenName = container.querySelector('input[name$="ingredient_name"]');
            const unitDisplay = container.closest('tr')?.querySelector('[data-ingredient-unit-display]');
            const costDisplay = container.closest('tr')?.querySelector('[data-ingredient-cost-display]');
            const totalCostDisplay = container.closest('tr')?.querySelector('[data-ingredient-total-cost-display]');
            const quantityInput = container.closest('tr')?.querySelector('input[name$="quantity"]');
            const hiddenUnit = container.querySelector('input[name$="ingredient_unit"]');
            if (!hiddenId || !label) return;

            if (hiddenId.value) {
                const optionButton = container.querySelector(`[data-ingredient-option][data-ingredient-id="${hiddenId.value}"]`);
                label.textContent = optionButton ? optionButton.dataset.ingredientName : 'Select ingredient';
                if (unitDisplay) {
                    unitDisplay.textContent = optionButton?.dataset.ingredientUnit || '--';
                }
                if (costDisplay) {
                    const costValue = optionButton?.dataset.ingredientCost;
                    costDisplay.textContent = costValue ? `$${costValue}` : '--';
                }
                if (totalCostDisplay) {
                    const costValue = parseFloat(optionButton?.dataset.ingredientCost || '');
                    const quantityValue = parseFloat(quantityInput?.value || '');
                    if (!Number.isNaN(costValue) && !Number.isNaN(quantityValue)) {
                        totalCostDisplay.textContent = `$${(costValue * quantityValue).toFixed(2)}`;
                    } else {
                        totalCostDisplay.textContent = '--';
                    }
                }
                if (hiddenName) hiddenName.value = '';
                if (hiddenUnit) hiddenUnit.value = '';
            } else if (hiddenName && hiddenName.value) {
                label.textContent = hiddenName.value;
                if (unitDisplay) {
                    const unitOption = hiddenUnit?.value
                        ? document.querySelector(`#missing-ingredient-unit option[value="${hiddenUnit.value}"]`)
                        : null;
                    unitDisplay.textContent = unitOption ? unitOption.textContent : '--';
                }
                if (costDisplay) costDisplay.textContent = '--';
                if (totalCostDisplay) totalCostDisplay.textContent = '--';
            } else {
                label.textContent = 'Select ingredient';
                if (unitDisplay) unitDisplay.textContent = '--';
                if (costDisplay) costDisplay.textContent = '--';
                if (totalCostDisplay) totalCostDisplay.textContent = '--';
            }
        }

        function initIngredientDropdown(container) {
            const button = container.querySelector('[data-ingredient-dropdown-button]');
            const menu = container.querySelector('[data-ingredient-dropdown-menu]');
            const hiddenName = container.querySelector('input[name$="ingredient_name"]');
            const hiddenId = container.querySelector('input[name$="ingredient"]');
            const hiddenUnit = container.querySelector('input[name$="ingredient_unit"]');
            const missingButton = container.querySelector('[data-ingredient-missing-trigger]');
            if (!button || !menu || !hiddenId || !hiddenUnit || !missingButton) return;

            updateIngredientDropdownLabel(container);

            const row = container.closest('tr');
            const quantityInput = row?.querySelector('input[name$="quantity"]');
            if (quantityInput) {
                quantityInput.addEventListener('input', function() {
                    updateIngredientDropdownLabel(container);
                });
            }

            button.addEventListener('click', function() {
                menu.classList.toggle('hidden');
            });

            container.addEventListener('click', function(event) {
                const optionButton = event.target.closest('[data-ingredient-option]');
                const missingTrigger = event.target.closest('[data-ingredient-missing-trigger]');
                if (optionButton) {
                    hiddenId.value = optionButton.dataset.ingredientId || '';
                    if (hiddenName) hiddenName.value = '';
                    if (hiddenUnit) hiddenUnit.value = '';
                    updateIngredientDropdownLabel(container);
                    menu.classList.add('hidden');
                }

                if (missingTrigger) {
                    menu.classList.add('hidden');
                    openMissingIngredientModal(container);
                }
            });

            document.addEventListener('click', function(event) {
                if (!container.contains(event.target) && !menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        }

        let activeMissingDropdown = null;

        function openMissingIngredientModal(container) {
            activeMissingDropdown = container;
            const modal = document.getElementById('modal-missing-ingredient');
            document.getElementById('missing-ingredient-name').value = '';
            document.getElementById('missing-ingredient-unit').value = '';
            document.getElementById('missing-ingredient-cost').value = '';
            modal.showModal();
        }

        document.querySelectorAll('[data-ingredient-dropdown]').forEach(initIngredientDropdown);

        // 1. Logic to Add Row
        addButton.addEventListener('click', function() {
            const formCount = parseInt(totalForms.value);
            // Replace __prefix__ with the current index (e.g., 0, 1, 2)
            const newRowHtml = emptyFormHtml.replace(/__prefix__/g, formCount);
            
            // Append to table
            container.insertAdjacentHTML('beforeend', newRowHtml);
            
            // Increment form count
            totalForms.value = formCount + 1;

            // Init dropdown for the new row
            const newRow = container.lastElementChild;
            const dropdown = newRow ? newRow.querySelector('[data-ingredient-dropdown]') : null;
            if (dropdown) {
                initIngredientDropdown(dropdown);
            }
        });

        // 2. Logic to Remove Row (Delegated Event)
        container.addEventListener('click', function(e) {
            if (e.target.closest('.edit-row-btn')) {
                const row = e.target.closest('tr');
                const dropdown = row?.querySelector('[data-ingredient-dropdown]');
                const menu = dropdown?.querySelector('[data-ingredient-dropdown-menu]');
                const quantityInput = row?.querySelector('input[name$="quantity"]');
                if (menu) {
                    menu.classList.remove('hidden');
                }
                if (quantityInput) {
                    quantityInput.focus();
                }
            }
            if (e.target.closest('.remove-row-btn')) {
                const row = e.target.closest('tr');
                const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
                
                if (deleteCheckbox) {
                    // It's an existing record: Check the box, hide the row
                    deleteCheckbox.checked = true;
                    row.style.display = 'none';
                } else {
                    // It's a brand new row (not saved yet): Remove from DOM
                    row.remove();
                    // Optional: You could decrement TOTAL_FORMS here, but Django handles gaps fine
                }
            }
        });

        const addIngredientUrl = "{% url 'add_ingredient' %}";
        function appendIngredientOption(ingredient) {
            document.querySelectorAll('[data-ingredient-options]').forEach((list) => {
                const item = document.createElement('div');
                item.className = 'ingredient-dropdown-item';
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'ingredient-dropdown-option';
                button.setAttribute('data-ingredient-option', '');
                button.dataset.ingredientId = ingredient.id;
                button.dataset.ingredientName = ingredient.name;
                button.dataset.ingredientUnit = ingredient.unit;
                button.dataset.ingredientCost = ingredient.cost_per_unit_amount || '';
                button.textContent = ingredient.name;
                item.appendChild(button);
                list.appendChild(item);
            });
        }

        const missingSaveBtn = document.getElementById('missing-ingredient-save');
        if (missingSaveBtn) {
            missingSaveBtn.addEventListener('click', async function() {
                const nameInput = document.getElementById('missing-ingredient-name');
                const unitSelect = document.getElementById('missing-ingredient-unit');
                const costInput = document.getElementById('missing-ingredient-cost');
                const name = nameInput.value.trim();
                const unitId = unitSelect.value;
                const costValue = costInput.value.trim() || '0';
                if (!activeMissingDropdown || !name || !unitId) return;

                const formData = new FormData();
                formData.append('name', name);
                formData.append('quantity', '0');
                formData.append('unit', unitId);
                formData.append('cost_per_unit_0', costValue);
                formData.append('cost_per_unit_1', 'USD');

                const response = await fetch(addIngredientUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData,
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert('Unable to add ingredient. ' + JSON.stringify(data.errors || {}));
                    return;
                }

                const ingredient = await response.json();
                appendIngredientOption(ingredient);

                const hiddenId = activeMissingDropdown.querySelector('input[name$="ingredient"]');
                const hiddenName = activeMissingDropdown.querySelector('input[name$="ingredient_name"]');
                const hiddenUnit = activeMissingDropdown.querySelector('input[name$="ingredient_unit"]');
                if (hiddenId) hiddenId.value = ingredient.id;
                if (hiddenName) hiddenName.value = '';
                if (hiddenUnit) hiddenUnit.value = '';
                updateIngredientDropdownLabel(activeMissingDropdown);
                document.getElementById('modal-missing-ingredient').close();
            });
        }

        const missingUnitAddBtn = document.getElementById('missing-unit-add-btn');
        if (missingUnitAddBtn) {
            missingUnitAddBtn.addEventListener('click', function() {
                document.getElementById('missing-unit-name').value = '';
                document.getElementById('modal-missing-unit-add').showModal();
            });
        }

        const missingUnitAddForm = document.getElementById('missing-unit-add-form');
        if (missingUnitAddForm) {
            missingUnitAddForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const unitName = document.getElementById('missing-unit-name').value.trim();
                if (!unitName) return;
                const formData = new FormData();
                formData.append('unit-name', unitName);
                const response = await fetch(missingUnitAddForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: formData,
                });
                if (response.ok) {
                    const unit = await response.json();
                    const unitSelect = document.getElementById('missing-ingredient-unit');
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = unit.name;
                    unitSelect.appendChild(option);
                    unitSelect.value = String(unit.id);
                    document.getElementById('modal-missing-unit-add').close();
                } else {
                    const data = await response.json();
                    alert('Unable to add unit. ' + JSON.stringify(data.errors || {}));
                }
            });
        }

        const validationModal = document.getElementById('modal-recipe-validation');
        const validationList = document.getElementById('recipe-validation-list');
        const validationClose = document.getElementById('recipe-validation-close');

        function getRowData(row) {
            const ingredientId = row.querySelector('input[name$="ingredient"]')?.value?.trim();
            const ingredientName = row.querySelector('input[name$="ingredient_name"]')?.value?.trim();
            const quantityValue = row.querySelector('input[name$="quantity"]')?.value?.trim();
            const isDeleted = row.querySelector('input[type="checkbox"][name$="-DELETE"]')?.checked;
            return {
                ingredientId,
                ingredientName,
                quantityValue,
                isDeleted,
            };
        }

        function buildValidationErrors() {
            const errors = [];
            const nameInput = recipeForm?.querySelector('input[name$="name"]');
            const instructionsInput = recipeForm?.querySelector('textarea[name$="instructions"]');

            if (nameInput && !nameInput.value.trim()) {
                errors.push('Recipe name is required.');
            }
            if (instructionsInput && !instructionsInput.value.trim()) {
                errors.push('Instructions are required.');
            }

            let hasValidIngredient = false;
            let hasIngredientMissingQuantity = false;
            let hasQuantityMissingIngredient = false;

            container?.querySelectorAll('tr.ingredient-row').forEach((row) => {
                const { ingredientId, ingredientName, quantityValue, isDeleted } = getRowData(row);
                if (isDeleted || row.style.display === 'none') return;

                const hasIngredient = Boolean(ingredientId || ingredientName);
                const hasQuantity = quantityValue !== '' && !Number.isNaN(parseFloat(quantityValue));

                if (hasIngredient && hasQuantity) {
                    hasValidIngredient = true;
                } else if (hasIngredient && !hasQuantity) {
                    hasIngredientMissingQuantity = true;
                } else if (!hasIngredient && hasQuantity) {
                    hasQuantityMissingIngredient = true;
                }
            });

            if (!hasValidIngredient) {
                errors.push('At least one ingredient with a quantity is required.');
            }
            if (hasIngredientMissingQuantity) {
                errors.push('Each selected ingredient needs a quantity.');
            }
            if (hasQuantityMissingIngredient) {
                errors.push('Each quantity needs an ingredient selection.');
            }

            return errors;
        }

        function showValidationModal(errors) {
            if (!validationModal || !validationList) return;
            validationList.innerHTML = '';
            errors.forEach((error) => {
                const item = document.createElement('li');
                item.textContent = error;
                validationList.appendChild(item);
            });
            validationModal.showModal();
        }

        if (validationClose) {
            validationClose.addEventListener('click', function() {
                validationModal?.close();
            });
        }

        if (recipeForm) {
            recipeForm.addEventListener('submit', function(event) {
                const errors = buildValidationErrors();
                if (errors.length) {
                    event.preventDefault();
                    showValidationModal(errors);
                }
            });
        }
    });
</script>

<dialog id="modal-recipe-validation" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="p-4 border-b flex justify-between items-center" style="background-color: #071B26; border-color: #58A7A6;">
        <h3 class="text-white font-bold text-base">Unable to save recipe</h3>
        <button type="button" id="recipe-validation-close" class="text-white/70 hover:text-white transition">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>
    <div class="p-5 bg-white">
        <p class="text-sm text-gray-600 mb-3">Please fix the following before saving:</p>
        <ul id="recipe-validation-list" class="text-sm text-brand-dark space-y-2 list-disc pl-5"></ul>
        <div class="mt-5 flex justify-end">
            <button type="button" class="px-4 py-2 rounded-lg font-bold text-white" style="background-color: #58A7A6;" onclick="this.closest('dialog').close()">Close</button>
        </div>
    </div>
</dialog>

<dialog id="modal-missing-ingredient" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-sm open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-base">Missing Ingredient</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="p-5 bg-white">
        <div class="mb-4">
            <label class="block text-brand-dark font-bold mb-2" for="missing-ingredient-name">Ingredient Name</label>
            <input id="missing-ingredient-name" type="text" class="form-input" placeholder="e.g. Buttermilk">
        </div>
        <div class="mb-4">
            <label class="block text-brand-dark font-bold mb-2" for="missing-ingredient-unit">Unit</label>
            <select id="missing-ingredient-unit" class="form-input">
                <option value="">Select unit</option>
                {% for unit in units %}
                    <option value="{{ unit.id }}">{{ unit.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="text-xs text-brand-teal font-bold mt-2" id="missing-unit-add-btn">+ Add Unit</button>
        </div>
        <div class="mb-4">
            <label class="block text-brand-dark font-bold mb-2" for="missing-ingredient-cost">Cost per Unit</label>
            <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                <input id="missing-ingredient-cost" type="number" step="0.01" inputmode="decimal" class="form-input pl-7 pr-12" placeholder="0.00">
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-gray-400">USD</span>
            </div>
        </div>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="button" class="btn-save-primary text-white px-5 py-2 rounded-lg font-bold transition" id="missing-ingredient-save" style="background-color: #58A7A6 !important;">Save</button>
        </div>
    </div>
</dialog>

<dialog id="modal-missing-unit-add" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-sm open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-base">Add Unit</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <form method="POST" action="{% url 'add_ingredient_unit' %}" class="p-5 bg-white" id="missing-unit-add-form">
        {% csrf_token %}
        <div>
            <label class="block text-brand-dark font-bold mb-2" for="missing-unit-name">Unit Name</label>
            <input id="missing-unit-name" type="text" class="form-input" placeholder="e.g. Pounds">
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="btn-save-primary text-white px-5 py-2 rounded-lg font-bold transition" style="background-color: #58A7A6 !important;">Save</button>
        </div>
    </form>
</dialog>
{% endblock %}