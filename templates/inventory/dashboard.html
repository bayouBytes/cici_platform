{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b-2 border-brand-teal/20 pb-4 gap-4">
    <div>
        <h1 class="text-4xl font-bold text-brand-dark tracking-tight">Chef's Dashboard</h1>
        <p class="text-gray-500 mt-1">Manage pantry, recipes, and the weekly drop.</p>
    </div>
    <div class="text-right">
        <span class="block text-xs uppercase tracking-wider text-gray-400 font-bold mb-1">Current Status</span>
        {% if active_week %}
            <span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold bg-green-100 text-green-800 shadow-sm border border-green-200">
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full mr-2 animate-pulse"></span> Kitchen Open
            </span>
        {% else %}
            <span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold bg-red-100 text-red-800 shadow-sm border border-red-200">
                <span class="w-2.5 h-2.5 bg-red-500 rounded-full mr-2"></span> Kitchen Closed
            </span>
        {% endif %}
    </div>
</div>

<div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden mb-8">
    <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
        <h3 class="text-brand-light font-bold text-lg tracking-wide">
            <i class="fa-solid fa-receipt mr-2 text-brand-teal"></i>
            Orders
            {% if current_week %}
                <span class="ml-2 text-xs font-semibold text-brand-teal">{{ current_week.name }}</span>
            {% endif %}
        </h3>
        {% if active_week %}
            <span class="text-xs uppercase tracking-wider text-brand-teal font-bold">Active Drop</span>
        {% else %}
            <span class="text-xs uppercase tracking-wider text-gray-400 font-bold">No Active Drop</span>
        {% endif %}
    </div>
    <div class="p-0 overflow-x-auto dashboard-table">
        <table class="w-full text-left text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                <tr>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Customer</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Meal</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Qty</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Price / Meal</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Cost / Meal</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Line Total</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Line Cost</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Line Profit</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Order Total</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Order Cost</th>
                    <th class="px-6 py-3 text-right font-semibold text-brand-teal">Order Profit</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for item in order_items %}
                <tr class="hover:bg-brand-light/50 transition group">
                    <td class="px-6 py-3 font-medium text-brand-dark">
                        {{ item.order.customer_name|default:item.order.customer.username }}
                    </td>
                    <td class="px-6 py-3 text-gray-700">
                        {{ item.meal_name|default:item.menu_item.meal.name }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-700">
                        {{ item.quantity }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.unit_price }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.unit_cost }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.line_price }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.line_cost }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.line_profit }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.order.total_price }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.order.total_cost }}
                    </td>
                    <td class="px-6 py-3 text-right font-mono text-gray-600">
                        {{ item.order.total_profit }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="px-6 py-8 text-center text-gray-400 italic">
                        No orders yet for this drop.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full ingredient-card relative">
        <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
            <h3 class="text-brand-light font-bold text-lg tracking-wide">
                <i class="fa-solid fa-box-open mr-2 text-brand-teal"></i>
                Ingredients
                <span class="ml-2 text-xs font-semibold text-brand-teal">Total {{ ingredient_total_value }}</span>
            </h3>
            <button onclick="document.getElementById('modal-ingredient').showModal()" 
                    class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
                + Add New
            </button>
        </div>
        <div class="p-0 overflow-x-auto flex-grow dashboard-table">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Name</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">In Stock</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Unit</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Cost / Unit</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Total Cost</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for ing in ingredients %}
                    <tr class="hover:bg-brand-light/50 transition group">
                        <td class="px-6 py-3 font-medium text-brand-dark group-hover:text-brand-teal transition-colors">
                            <button type="button"
                                    class="text-left hover:underline"
                                    data-edit-url="{% url 'edit_ingredient' ing.id %}"
                                    data-name="{{ ing.name|escapejs }}"
                                    data-quantity="{{ ing.quantity }}"
                                    data-unit-id="{{ ing.unit_id }}"
                                    data-cost-amount="{{ ing.cost_per_unit.amount }}"
                                    data-cost-currency="{{ ing.cost_per_unit.currency }}"
                                    onclick="openIngredientEdit(this)">
                                {{ ing.name }}
                            </button>
                        </td>
                        <td class="px-6 py-3 font-mono text-gray-700">
                            {{ ing.quantity }}
                        </td>
                        <td class="px-6 py-3 font-mono text-gray-700" data-unit-id="{{ ing.unit_id }}">
                            {{ ing.unit_display }}
                        </td>
                        <td class="px-6 py-3 text-right text-gray-600 font-mono">
                            {{ ing.cost_per_unit }}
                        </td>
                        <td class="px-6 py-3 text-right text-gray-600 font-mono">
                            {{ ing.total_cost }}
                        </td>
                        <td class="px-6 py-3 text-right space-x-3">
                            <button type="button"
                                    class="text-gray-400 hover:text-brand-teal transition"
                                    title="Edit"
                                    data-edit-url="{% url 'edit_ingredient' ing.id %}"
                                    data-name="{{ ing.name|escapejs }}"
                                    data-quantity="{{ ing.quantity }}"
                                    data-unit-id="{{ ing.unit_id }}"
                                    data-cost-amount="{{ ing.cost_per_unit.amount }}"
                                    data-cost-currency="{{ ing.cost_per_unit.currency }}"
                                    onclick="openIngredientEdit(this)">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <a href="{% url 'delete_ingredient' ing.id %}"
                               class="text-gray-400 hover:text-red-500 transition"
                               title="Delete"
                               data-ingredient-delete
                               data-ingredient-name="{{ ing.name|escapejs }}">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">Pantry is empty.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="unit-delete-overlay hidden" data-ingredient-delete-confirm-box>
                <div class="unit-delete-confirm">
                    <div class="unit-delete-confirm__title">Delete Ingredient</div>
                    <div class="unit-delete-confirm__text" data-ingredient-delete-text></div>
                    <div class="unit-delete-confirm__actions">
                        <button type="button" class="unit-delete-confirm__cancel" data-ingredient-delete-cancel>Cancel</button>
                        <button type="button" class="unit-delete-confirm__confirm" data-ingredient-delete-confirm>Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full recipe-card relative">
        <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
            <h3 class="text-brand-light font-bold text-lg tracking-wide"><i class="fa-solid fa-book-open mr-2 text-brand-teal"></i> Recipes</h3>
            <a href="{% url 'add_recipe' %}" class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
                + Build Recipe
            </a>
        </div>
        <div class="p-0 flex-grow dashboard-table">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Dish</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Ingredients</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Base Cost</th>
                        <th class="px-6 py-3 text-center font-semibold text-brand-teal">Details</th> 
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for recipe in recipes %}
                    <tr class="hover:bg-brand-light/50 transition cursor-pointer" onclick="window.location.href='{% url 'edit_recipe' recipe.id %}'">
                        <td class="px-6 py-3 font-medium text-brand-dark">
                            <a href="{% url 'edit_recipe' recipe.id %}" class="hover:text-brand-teal hover:underline transition">
                                {{ recipe.name }}
                            </a>
                        </td>
                        <td class="px-6 py-3 text-gray-600 text-xs max-w-[260px]">
                            <div class="recipe-ingredients-cell">
                                {% with total=recipe.recipe_ingredients.count %}
                                    {% for ri in recipe.recipe_ingredients.all|slice:":3" %}
                                        <span class="inline-block border rounded-full px-2 py-0.5 mr-1 mb-1 {% if ri.is_in_stock %}bg-green-50 border-green-200 text-green-700{% else %}bg-red-50 border-red-200 text-red-700{% endif %}">
                                            {{ ri.display_name }} ({{ ri.quantity }}{% if ri.display_unit %} {{ ri.display_unit }}{% endif %})
                                            {% if not ri.is_in_stock %}
                                                (missing {{ ri.missing_amount|floatformat:2 }}{% if ri.display_unit %} {{ ri.display_unit }}{% endif %})
                                            {% endif %}
                                        </span>
                                    {% endfor %}
                                    {% if total > 3 %}
                                        <span class="inline-block text-gray-400 text-[10px] font-semibold uppercase tracking-wide align-middle">
                                            +{{ total|add:"-3" }} more
                                        </span>
                                    {% endif %}
                                {% endwith %}
                                <div class="recipe-ingredients-tooltip">
                                    {% for ri in recipe.recipe_ingredients.all %}
                                        <span class="inline-block border rounded-full px-2 py-0.5 mr-1 mb-1 {% if ri.is_in_stock %}bg-green-50 border-green-200 text-green-700{% else %}bg-red-50 border-red-200 text-red-700{% endif %}">
                                            {{ ri.display_name }} ({{ ri.quantity }}{% if ri.display_unit %} {{ ri.display_unit }}{% endif %})
                                            {% if not ri.is_in_stock %}
                                                (missing {{ ri.missing_amount|floatformat:2 }}{% if ri.display_unit %} {{ ri.display_unit }}{% endif %})
                                            {% endif %}
                                        </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-3 text-gray-600 font-mono">{{ recipe.calculate_cost }}</td>
                        
                        <td class="px-6 py-3 text-center">
                            {% if recipe.instructions %}
                                <button onclick="openInstructionsModal('{{ recipe.name|escapejs }}', '{{ recipe.instructions|escapejs }}', '{% for ri in recipe.recipe_ingredients.all %}{{ ri.display_name|escapejs }} ({{ ri.quantity }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% if not ri.is_in_stock %} (missing {{ ri.missing_amount|floatformat:2 }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% endif %}{% if not forloop.last %}, {% endif %}{% endfor %}')" 
                                        class="text-xs bg-brand-light text-brand-teal border border-brand-teal px-3 py-1 rounded-full hover:bg-brand-teal hover:text-white transition font-bold">
                                    View Ingredients &amp; Instructions
                                </button>
                            {% else %}
                                <span class="text-xs text-gray-300 italic">No text</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-3 text-right space-x-3">
                            <a href="{% url 'edit_recipe' recipe.id %}" class="text-gray-400 hover:text-brand-teal transition" title="Edit"><i class="fa-solid fa-pen-to-square"></i></a>
                            <a href="{% url 'delete_recipe' recipe.id %}"
                               class="text-gray-400 hover:text-red-500 transition"
                               title="Delete"
                               data-recipe-delete
                               data-recipe-name="{{ recipe.name|escapejs }}">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No recipes created yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="unit-delete-overlay hidden" data-recipe-delete-confirm-box>
                <div class="unit-delete-confirm">
                    <div class="unit-delete-confirm__title">Delete Recipe</div>
                    <div class="unit-delete-confirm__text" data-recipe-delete-text></div>
                    <div class="unit-delete-confirm__actions">
                        <button type="button" class="unit-delete-confirm__cancel" data-recipe-delete-cancel>Cancel</button>
                        <button type="button" class="unit-delete-confirm__confirm" data-recipe-delete-confirm>Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full meal-card relative">
    <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
        <h3 class="text-brand-light font-bold text-lg tracking-wide"><i class="fa-solid fa-utensils mr-2 text-brand-teal"></i> Meals</h3>
        <a href="{% url 'add_meal' %}" class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
            + Build Meal
        </a>
    </div>
    <div class="p-0 flex-grow dashboard-table">
        <table class="w-full text-left text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                <tr>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Meal Name</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Base Cost</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Price</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Profit</th>
                    <th class="px-6 py-3 text-center font-semibold text-brand-teal">Details</th>
                    <th class="px-6 py-3 text-center font-semibold text-brand-teal">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for meal in meals %}
                <tr class="hover:bg-brand-light/50 transition group">
                    <td class="px-6 py-4 font-medium text-brand-dark align-middle">{{ meal.name }}</td>
                    <td class="px-6 py-4 text-gray-600 font-mono align-middle">{{ meal.calculate_cost }}</td>
                    
                    <td class="px-6 py-4 font-bold text-brand-dark font-mono align-middle">
                        {% if meal.customer_price %}
                            {{ meal.customer_price }}
                        {% else %}
                            <span class="text-gray-300 text-xs">--</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 font-mono font-bold align-middle">
                        {% if meal.projected_profit.amount < 0 %}
                            <span class="text-red-500">
                                (${{ meal.projected_profit.amount|stringformat:".2f"|cut:"-" }})
                            </span>
                        {% else %}
                            <span class="text-green-600">
                                {{ meal.projected_profit }}
                            </span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-center align-middle">
                        {% if meal.description %}
                            <button onclick="openMealDetailsModal('{{ meal.name|escapejs }}', '{{ meal.description|escapejs }}', '{% for mr in meal.meal_recipes.all %}{{ mr.recipe.name|escapejs }}:::{% for ri in mr.recipe.recipe_ingredients.all %}{{ ri.display_name|escapejs }} ({{ ri.quantity }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% if not ri.is_in_stock %} (missing {{ ri.missing_amount|floatformat:2 }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% endif %}{% if not forloop.last %}; {% endif %}{% endfor %}{% if not forloop.last %}|||{% endif %}{% endfor %}')" 
                                    class="text-xs bg-brand-light text-brand-teal border border-brand-teal px-3 py-1 rounded-full hover:bg-brand-teal hover:text-white transition font-bold shadow-sm">
                                View Description
                            </button>
                        {% else %}
                            <span class="text-xs text-gray-300 italic">No notes</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-center align-middle space-x-3">
                        <a href="{% url 'edit_meal' meal.id %}" class="text-gray-400 hover:text-brand-teal transition inline-block"><i class="fa-solid fa-pen-to-square fa-lg"></i></a>
                        <a href="{% url 'delete_meal' meal.id %}"
                           class="text-gray-400 hover:text-red-500 transition inline-block"
                           data-meal-delete
                           data-meal-name="{{ meal.name|escapejs }}">
                            <i class="fa-solid fa-trash fa-lg"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="px-6 py-8 text-center text-gray-400 italic">No meals created yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="unit-delete-overlay hidden" data-meal-delete-confirm-box>
            <div class="unit-delete-confirm">
                <div class="unit-delete-confirm__title">Delete Meal</div>
                <div class="unit-delete-confirm__text" data-meal-delete-text></div>
                <div class="unit-delete-confirm__actions">
                    <button type="button" class="unit-delete-confirm__cancel" data-meal-delete-cancel>Cancel</button>
                    <button type="button" class="unit-delete-confirm__confirm" data-meal-delete-confirm>Delete</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full">
        <div class="bg-brand-dark p-5 flex flex-col md:flex-row justify-between items-center gap-4 border-b-4 border-brand-teal">
            <div>
                <h3 class="text-brand-light font-bold text-lg tracking-wide flex items-center">
                    <i class="fa-solid fa-calendar-week mr-2 text-brand-teal"></i> 
                    Active Drop
                </h3>
                <p class="text-brand-teal/80 text-sm mt-1 font-mono uppercase tracking-widest">{{ current_week.name|default:"NO DROP SCHEDULED" }}</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="document.getElementById('modal-week-create').showModal()" 
                        class="border border-brand-teal text-brand-teal text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition hover:bg-brand-teal hover:text-brand-dark">
                    + Create Week
                </button>
                {% if current_week %}
                    <button onclick="document.getElementById('modal-menu-item').showModal()" 
                            class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
                        + Add Meal to Drop
                    </button>
                    {% if current_week.is_archived %}
                        <span class="text-xs uppercase tracking-wider text-gray-300 font-bold">Archived</span>
                    {% else %}
                        <form method="POST" action="{% url 'archive_menu_week' current_week.id %}">
                            {% csrf_token %}
                            <button type="submit" class="border border-brand-teal text-brand-teal text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition hover:bg-brand-teal hover:text-brand-dark">
                                Archive
                            </button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        
        {% if current_week and menu_items %}
        <div class="p-0 flex-grow dashboard-table">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Meal</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Base Cost</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Price</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Profit</th>
                        <th class="px-6 py-3 text-center font-semibold text-brand-teal">Description</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for item in menu_items %}
                    <tr class="hover:bg-brand-light/50 transition">
                        <td class="px-6 py-3 font-medium text-brand-dark">{{ item.meal.name }}</td>
                        <td class="px-6 py-3 text-gray-600 font-mono">{{ item.meal.calculate_cost }}</td>
                        <td class="px-6 py-3 text-gray-600 font-mono">
                            {% if item.meal.customer_price %}
                                {{ item.meal.customer_price }}
                            {% else %}
                                <span class="text-gray-300 text-xs">--</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 font-mono font-bold">
                            {% if item.projected_profit %}
                                {% if item.projected_profit.amount < 0 %}
                                    <span class="text-red-500">
                                        (${{ item.projected_profit.amount|stringformat:".2f"|cut:"-" }})
                                    </span>
                                {% else %}
                                    <span class="text-green-600">
                                        {{ item.projected_profit }}
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-300 text-xs">--</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-center">
                            {% if item.meal.description %}
                                <button onclick="openMealDetailsModal('{{ item.meal.name|escapejs }}', '{{ item.meal.description|escapejs }}', '{% for mr in item.meal.meal_recipes.all %}{{ mr.recipe.name|escapejs }}:::{% for ri in mr.recipe.recipe_ingredients.all %}{{ ri.display_name|escapejs }} ({{ ri.quantity }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% if not ri.is_in_stock %} (missing {{ ri.missing_amount|floatformat:2 }}{% if ri.display_unit %} {{ ri.display_unit|escapejs }}{% endif %}){% endif %}{% if not forloop.last %}; {% endif %}{% endfor %}{% if not forloop.last %}|||{% endif %}{% endfor %}')" 
                                        class="text-xs bg-brand-light text-brand-teal border border-brand-teal px-3 py-1 rounded-full hover:bg-brand-teal hover:text-white transition font-bold shadow-sm">
                                    View Description
                                </button>
                            {% else %}
                                <span class="text-xs text-gray-300 italic">No notes</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-3 text-right space-x-3">
                            <button type="button"
                                    class="text-gray-400 hover:text-brand-teal transition"
                                    title="Edit"
                                    data-edit-url="{% url 'edit_menu_item' item.id %}"
                                    data-meal-id="{{ item.meal_id }}"
                                    data-menu-week-id="{{ item.menu_week_id }}"
                                    onclick="openMenuItemEdit(this)">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <a href="{% url 'delete_menu_item' item.id %}"
                               class="text-gray-400 hover:text-red-500 transition"
                               title="Delete"
                               data-menu-delete
                               data-menu-name="{{ item.meal.name|escapejs }}">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="px-6 py-8 text-center text-gray-400 italic">No meals added to this drop yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="unit-delete-overlay hidden" data-menu-delete-confirm-box>
                <div class="unit-delete-confirm">
                    <div class="unit-delete-confirm__title">Delete Drop Item</div>
                    <div class="unit-delete-confirm__text" data-menu-delete-text></div>
                    <div class="unit-delete-confirm__actions">
                        <button type="button" class="unit-delete-confirm__cancel" data-menu-delete-cancel>Cancel</button>
                        <button type="button" class="unit-delete-confirm__confirm" data-menu-delete-confirm>Delete</button>
                    </div>
                </div>
            </div>
        </div>
        {% elif current_week %}
             <div class="p-12 text-center text-gray-400">
                <i class="fa-solid fa-plate-wheat text-4xl mb-3 text-gray-200"></i>
                <p>No meals added to this drop yet.</p>
             </div>
        {% else %}
             <div class="p-12 text-center text-gray-400">
                <i class="fa-solid fa-calendar-xmark text-4xl mb-3 text-gray-200"></i>
                <p>Create a week to start building the drop.</p>
             </div>
        {% endif %}
        {% if archived_weeks %}
        <div class="border-t border-gray-100 px-6 py-4">
            <div class="text-xs uppercase tracking-wider text-gray-400 font-bold mb-2">Archived Drops</div>
            <div class="flex flex-wrap gap-2">
                {% for week in archived_weeks %}
                    <a href="/admin/store/menuweek/{{ week.id }}/change/" class="text-xs text-brand-teal underline hover:text-brand-dark">
                        {{ week.name }}
                    </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<dialog id="modal-ingredient" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Add Ingredient</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" action="{% url 'add_ingredient' %}" class="p-6 bg-white">
        {% csrf_token %}
        {% if ingredient_form.non_field_errors %}
            <div class="mb-4 text-sm text-red-600">
                {{ ingredient_form.non_field_errors }}
            </div>
        {% endif %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.name.id_for_label }}">Name</label>
                {{ ingredient_form.name }}
                {{ ingredient_form.name.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.quantity.id_for_label }}">Quantity</label>
                {{ ingredient_form.quantity }}
                {{ ingredient_form.quantity.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.unit.id_for_label }}">Unit</label>
                <div class="relative" data-unit-dropdown>
                    {{ ingredient_form.unit }}
                    <button type="button" class="unit-dropdown-button" data-unit-dropdown-button>
                        <span data-unit-selected-label>Select unit</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div class="unit-dropdown-menu hidden" data-unit-dropdown-menu>
                        <button type="button" class="unit-dropdown-action" data-unit-add>
                            + Add Unit
                        </button>
                        <div class="unit-dropdown-list" data-delete-url-template="{% url 'delete_ingredient_unit' 0 %}">
                            {% for unit in units %}
                                <div class="unit-dropdown-item">
                                    <button type="button" class="unit-dropdown-option" data-unit-option data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name|escapejs }}">
                                        {{ unit.name }}
                                    </button>
                                    <button type="button" class="unit-dropdown-icon unit-dropdown-edit" title="Edit {{ unit.name }}" data-unit-edit data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name|escapejs }}">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <a href="{% url 'delete_ingredient_unit' unit.id %}"
                                       class="unit-dropdown-icon unit-dropdown-delete"
                                       title="Delete {{ unit.name }}"
                                       data-unit-delete
                                       data-unit-name="{{ unit.name|escapejs }}">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {{ ingredient_form.unit.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.cost_per_unit.id_for_label }}">Cost per Unit</label>
                <div class="relative">
                    <i class="fa-solid fa-dollar-sign absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    {{ ingredient_form.cost_per_unit.subwidgets.0 }}
                </div>
                {{ ingredient_form.cost_per_unit.subwidgets.1 }}
                {{ ingredient_form.cost_per_unit.errors }}
            </div>
        </div>
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="btn-save-primary text-white px-6 py-2 rounded-lg font-bold transition shadow-md" style="background-color: #58A7A6 !important;">Save</button>
        </div>
    </form>
    <div class="unit-delete-overlay hidden" data-unit-delete-confirm-box>
        <div class="unit-delete-confirm">
            <div class="unit-delete-confirm__title">Delete Unit</div>
            <div class="unit-delete-confirm__text" data-unit-delete-text></div>
            <div class="unit-delete-confirm__actions">
                <button type="button" class="unit-delete-confirm__cancel" data-unit-delete-cancel>Cancel</button>
                <button type="button" class="unit-delete-confirm__confirm" data-unit-delete-confirm>Delete</button>
            </div>
        </div>
    </div>
    <div class="unit-delete-overlay hidden" data-unit-rename-confirm-box>
        <div class="unit-delete-confirm">
            <div class="unit-delete-confirm__title">Unit In Use</div>
            <div class="unit-delete-confirm__text" data-unit-rename-text></div>
            <label class="block text-brand-dark font-bold mb-2 text-sm" for="unit-rename-input-add">Rename To</label>
            <input id="unit-rename-input-add" type="text" class="form-input mb-3" />
            <div class="unit-delete-confirm__actions">
                <button type="button" class="unit-delete-confirm__cancel" data-unit-rename-cancel>Cancel</button>
                <button type="button" class="unit-delete-confirm__confirm" data-unit-rename-confirm>Save</button>
            </div>
        </div>
    </div>
</dialog>

<dialog id="modal-week-create" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Create Drop Week</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" action="{% url 'create_menu_week' %}" class="p-6 bg-white">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ menu_week_form.name.id_for_label }}">Week Name</label>
                {{ menu_week_form.name }}
                {{ menu_week_form.name.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ menu_week_form.start_date.id_for_label }}">Start Date</label>
                {{ menu_week_form.start_date }}
                {{ menu_week_form.start_date.errors }}
            </div>
            <label class="flex items-center gap-2 text-sm font-semibold text-brand-dark">
                {{ menu_week_form.is_active }}
                <span>Make active now</span>
            </label>
        </div>
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="btn-save-primary text-white px-6 py-2 rounded-lg font-bold transition shadow-md">Create Week</button>
        </div>
    </form>
</dialog>

<dialog id="modal-ingredient-edit" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Edit Ingredient</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" id="ingredient-edit-form" class="p-6 bg-white">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.name.id_for_label }}">Name</label>
                {{ edit_ingredient_form.name }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.quantity.id_for_label }}">Quantity</label>
                {{ edit_ingredient_form.quantity }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.unit.id_for_label }}">Unit</label>
                <div class="relative" data-unit-dropdown>
                    {{ edit_ingredient_form.unit }}
                    <button type="button" class="unit-dropdown-button" data-unit-dropdown-button>
                        <span data-unit-selected-label>Select unit</span>
                        <i class="fa-solid fa-chevron-down text-gray-400"></i>
                    </button>
                    <div class="unit-dropdown-menu hidden" data-unit-dropdown-menu>
                        <button type="button" class="unit-dropdown-action" data-unit-add>
                            + Add Unit
                        </button>
                        <div class="unit-dropdown-list" data-delete-url-template="{% url 'delete_ingredient_unit' 0 %}">
                            {% for unit in units %}
                                <div class="unit-dropdown-item">
                                    <button type="button" class="unit-dropdown-option" data-unit-option data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name|escapejs }}">
                                        {{ unit.name }}
                                    </button>
                                    <button type="button" class="unit-dropdown-icon unit-dropdown-edit" title="Edit {{ unit.name }}" data-unit-edit data-unit-id="{{ unit.id }}" data-unit-name="{{ unit.name|escapejs }}">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                    <a href="{% url 'delete_ingredient_unit' unit.id %}"
                                       class="unit-dropdown-icon unit-dropdown-delete"
                                       title="Delete {{ unit.name }}"
                                       data-unit-delete
                                       data-unit-name="{{ unit.name|escapejs }}">
                                        <i class="fa-solid fa-trash"></i>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.cost_per_unit.id_for_label }}">Cost per Unit</label>
                <div class="relative">
                    <i class="fa-solid fa-dollar-sign absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    {{ edit_ingredient_form.cost_per_unit.subwidgets.0 }}
                </div>
                {{ edit_ingredient_form.cost_per_unit.subwidgets.1 }}
            </div>
        </div>
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="btn-save-primary text-white px-6 py-2 rounded-lg font-bold transition shadow-md" style="background-color: #58A7A6 !important;">Save</button>
        </div>
    </form>
    <div class="unit-delete-overlay hidden" data-unit-delete-confirm-box>
        <div class="unit-delete-confirm">
            <div class="unit-delete-confirm__title">Delete Unit</div>
            <div class="unit-delete-confirm__text" data-unit-delete-text></div>
            <div class="unit-delete-confirm__actions">
                <button type="button" class="unit-delete-confirm__cancel" data-unit-delete-cancel>Cancel</button>
                <button type="button" class="unit-delete-confirm__confirm" data-unit-delete-confirm>Delete</button>
            </div>
        </div>
    </div>
    <div class="unit-delete-overlay hidden" data-unit-rename-confirm-box>
        <div class="unit-delete-confirm">
            <div class="unit-delete-confirm__title">Unit In Use</div>
            <div class="unit-delete-confirm__text" data-unit-rename-text></div>
            <label class="block text-brand-dark font-bold mb-2 text-sm" for="unit-rename-input-edit">Rename To</label>
            <input id="unit-rename-input-edit" type="text" class="form-input mb-3" />
            <div class="unit-delete-confirm__actions">
                <button type="button" class="unit-delete-confirm__cancel" data-unit-rename-cancel>Cancel</button>
                <button type="button" class="unit-delete-confirm__confirm" data-unit-rename-confirm>Save</button>
            </div>
        </div>
    </div>
</dialog>

<dialog id="modal-unit-add" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-sm open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-base">Add Unit</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <form method="POST" action="{% url 'add_ingredient_unit' %}" class="p-5 bg-white" id="unit-add-form">
        {% csrf_token %}
        <div>
            <label class="block text-brand-dark font-bold mb-2" for="{{ unit_form.name.id_for_label }}">Unit Name</label>
            {{ unit_form.name }}
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-5 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Save</button>
        </div>
    </form>
</dialog>

<dialog id="modal-unit-edit" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-sm open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-base">Edit Unit</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <form method="POST" class="p-5 bg-white" id="unit-edit-form">
        {% csrf_token %}
        <div>
            <label class="block text-brand-dark font-bold mb-2" for="{{ edit_unit_form.name.id_for_label }}">Unit Name</label>
            {{ edit_unit_form.name }}
        </div>
        <div class="mt-6 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-5 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Save</button>
        </div>
    </form>
</dialog>

<dialog id="modal-menu-item" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Add Meal to Drop</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" action="{% url 'add_menu_item' %}" class="p-6 bg-white">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ menu_item_form.meal.id_for_label }}">Meal</label>
                {{ menu_item_form.meal }}
                {{ menu_item_form.meal.errors }}
            </div>
        </div>
        {{ menu_item_form.menu_week }}
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-6 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Add to Drop</button>
        </div>
    </form>
</dialog>

<dialog id="modal-menu-item-edit" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Edit Drop Item</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" class="p-6 bg-white" id="menu-item-edit-form">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_menu_item_form.meal.id_for_label }}">Meal</label>
                {{ edit_menu_item_form.meal }}
                {{ edit_menu_item_form.meal.errors }}
            </div>
        </div>
        {{ edit_menu_item_form.menu_week }}
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="btn-save-primary text-white px-6 py-2 rounded-lg font-bold transition shadow-md">Save</button>
        </div>
    </form>
</dialog>

<dialog id="modal-instructions" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-lg open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 id="modal-instructions-title" class="text-white font-bold text-lg">Recipe Name</h3>
        <button onclick="document.getElementById('modal-instructions').close()" class="text-gray-400 hover:text-white transition">
            <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
    </div>
    <div class="p-8 bg-white">
        <div class="mb-6">
            <h4 id="modal-instructions-list-title" class="text-xs uppercase tracking-wider text-brand-teal font-bold mb-2">Ingredients</h4>
            <ul id="modal-instructions-ingredients" class="text-gray-600 text-sm list-disc pl-5"></ul>
        </div>
        <div class="mb-2">
            <h4 id="modal-instructions-text-title" class="text-xs uppercase tracking-wider text-brand-teal font-bold">Instructions</h4>
        </div>
        <div class="prose prose-sm max-w-none text-gray-600 leading-relaxed">
            <p id="modal-instructions-text" class="whitespace-pre-wrap"></p>
        </div>
        <div class="mt-8 flex justify-end">
            <button onclick="document.getElementById('modal-instructions').close()" class="bg-gray-100 text-gray-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-200 transition">
                Close
            </button>
        </div>
    </div>
</dialog>

<script>
    function openIngredientEdit(trigger) {
        const modal = document.getElementById('modal-ingredient-edit');
        const form = document.getElementById('ingredient-edit-form');

        if (!modal || !form) return;

        form.action = trigger.dataset.editUrl;
        document.getElementById('{{ edit_ingredient_form.name.id_for_label }}').value = trigger.dataset.name || '';
        document.getElementById('{{ edit_ingredient_form.quantity.id_for_label }}').value = trigger.dataset.quantity || '';
        document.getElementById('{{ edit_ingredient_form.unit.id_for_label }}').value = trigger.dataset.unitId || '';

        const amountInput = form.querySelector('input[name$="cost_per_unit_0"]');
        const currencyInput = form.querySelector('[name$="cost_per_unit_1"]');
        if (amountInput) amountInput.value = trigger.dataset.costAmount || '';
        if (currencyInput) currencyInput.value = trigger.dataset.costCurrency || 'USD';

        const dropdown = form.querySelector('[data-unit-dropdown]');
        if (dropdown) updateUnitDropdownLabel(dropdown);
        modal.showModal();
    }

    function setModalDetails(title, text) {
        const modal = document.getElementById('modal-instructions');
        const titleEl = document.getElementById('modal-instructions-title');
        const textEl = document.getElementById('modal-instructions-text');
        const textTitleEl = document.getElementById('modal-instructions-text-title');
        titleEl.textContent = title;
        textEl.textContent = text;
        if (textTitleEl) {
            textTitleEl.textContent = 'Instructions';
        }
        return modal;
    }

    function setModalList(listTitle, items, emptyText) {
        const titleEl = document.getElementById('modal-instructions-list-title');
        const ingredientsEl = document.getElementById('modal-instructions-ingredients');
        titleEl.textContent = listTitle;
        ingredientsEl.innerHTML = '';
        if (items && items.length) {
            items.forEach(function(item) {
                const text = String(item || '').trim();
                if (!text) return;
                const li = document.createElement('li');
                li.textContent = text;
                ingredientsEl.appendChild(li);
            });
        }
        if (!ingredientsEl.children.length) {
            const li = document.createElement('li');
            li.textContent = emptyText;
            ingredientsEl.appendChild(li);
        }
    }

    function openInstructionsModal(title, text, ingredients) {
        const modal = setModalDetails(title, text);
        const items = ingredients ? ingredients.split(',').map((item) => item.trim()).filter(Boolean) : [];
        setModalList('Ingredients', items, 'No ingredients listed.');
        modal.showModal();
    }

    function openMealDetailsModal(title, text, recipes) {
        const modal = setModalDetails(title, text);
        const textTitleEl = document.getElementById('modal-instructions-text-title');
        if (textTitleEl) {
            textTitleEl.textContent = 'Description';
        }
        const items = [];

        if (recipes) {
            recipes.split('|||').forEach(function(entry) {
                const trimmed = entry.trim();
                if (!trimmed) return;
                const parts = trimmed.split(':::');
                const recipeName = (parts[0] || '').trim();
                const ingredients = (parts[1] || '').trim();
                if (!recipeName) return;
                if (ingredients) {
                    items.push(`${recipeName}: ${ingredients}`);
                } else {
                    items.push(recipeName);
                }
            });
        }

        setModalList('Recipes', items, 'No recipes listed.');
        modal.showModal();
    }

    function openMenuItemEdit(trigger) {
        const modal = document.getElementById('modal-menu-item-edit');
        const form = document.getElementById('menu-item-edit-form');
        if (!modal || !form) return;

        form.action = trigger.dataset.editUrl;
        const mealSelect = document.getElementById('{{ edit_menu_item_form.meal.id_for_label }}');
        if (mealSelect) mealSelect.value = trigger.dataset.mealId || '';

        const weekInput = form.querySelector('input[name$="menu_week"]');
        if (weekInput) weekInput.value = trigger.dataset.menuWeekId || '';

        modal.showModal();
    }

    function openRecipeDeleteConfirm(trigger) {
        const card = trigger.closest('.recipe-card');
        const confirmBox = card?.querySelector('[data-recipe-delete-confirm-box]');
        const textEl = card?.querySelector('[data-recipe-delete-text]');
        if (!confirmBox || !textEl) return;

        confirmBox.dataset.deleteUrl = trigger.getAttribute('href');
        textEl.textContent = `Delete ${trigger.dataset.recipeName || 'this recipe'}?`;
        confirmBox.classList.remove('hidden');
    }

    function openIngredientDeleteConfirm(trigger) {
        const card = trigger.closest('.ingredient-card');
        const confirmBox = card?.querySelector('[data-ingredient-delete-confirm-box]');
        const textEl = card?.querySelector('[data-ingredient-delete-text]');
        if (!confirmBox || !textEl) return;

        confirmBox.dataset.deleteUrl = trigger.getAttribute('href');
        textEl.textContent = `Delete ${trigger.dataset.ingredientName || 'this ingredient'}?`;
        confirmBox.classList.remove('hidden');
    }

    function openMealDeleteConfirm(trigger) {
        const card = trigger.closest('.meal-card');
        const confirmBox = card?.querySelector('[data-meal-delete-confirm-box]');
        const textEl = card?.querySelector('[data-meal-delete-text]');
        if (!confirmBox || !textEl) return;

        confirmBox.dataset.deleteUrl = trigger.getAttribute('href');
        textEl.textContent = `Delete ${trigger.dataset.mealName || 'this meal'}?`;
        confirmBox.classList.remove('hidden');
    }

    function openMenuDeleteConfirm(trigger) {
        const card = trigger.closest('.bg-white');
        const confirmBox = card?.querySelector('[data-menu-delete-confirm-box]');
        const textEl = card?.querySelector('[data-menu-delete-text]');
        if (!confirmBox || !textEl) return;

        confirmBox.dataset.deleteUrl = trigger.getAttribute('href');
        textEl.textContent = `Delete ${trigger.dataset.menuName || 'this item'} from the drop?`;
        confirmBox.classList.remove('hidden');
    }

    function updateUnitDropdownLabel(container) {
        const select = container.querySelector('select');
        const label = container.querySelector('[data-unit-selected-label]');
        if (!select || !label) return;

        const selectedOption = select.options[select.selectedIndex];
        label.textContent = selectedOption ? selectedOption.text : 'Select unit';
    }

    let activeUnitDropdown = null;

    function openUnitAdd(container) {
        activeUnitDropdown = container || null;
        const modal = document.getElementById('modal-unit-add');
        const input = document.getElementById('{{ unit_form.name.id_for_label }}');
        if (input) input.value = '';
        modal.showModal();
    }

    function openUnitEdit(unitId, unitName) {
        const modal = document.getElementById('modal-unit-edit');
        const form = document.getElementById('unit-edit-form');
        const input = document.getElementById('{{ edit_unit_form.name.id_for_label }}');
        if (form) form.action = "{% url 'edit_ingredient_unit' 0 %}".replace('0', unitId);
        if (input) input.value = unitName || '';
        modal.showModal();
    }

    function createUnitItem(unit, deleteUrlTemplate) {
        const row = document.createElement('div');
        row.className = 'unit-dropdown-item';

        const optionButton = document.createElement('button');
        optionButton.type = 'button';
        optionButton.className = 'unit-dropdown-option';
        optionButton.dataset.unitOption = '';
        optionButton.dataset.unitId = unit.id;
        optionButton.dataset.unitName = unit.name;
        optionButton.textContent = unit.name;

        const editButton = document.createElement('button');
        editButton.type = 'button';
        editButton.className = 'unit-dropdown-icon unit-dropdown-edit';
        editButton.title = `Edit ${unit.name}`;
        editButton.dataset.unitEdit = '';
        editButton.dataset.unitId = unit.id;
        editButton.dataset.unitName = unit.name;
        editButton.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';

        const deleteLink = document.createElement('a');
        deleteLink.className = 'unit-dropdown-icon unit-dropdown-delete';
        deleteLink.title = `Delete ${unit.name}`;
        deleteLink.href = deleteUrlTemplate.replace('0', unit.id);
        deleteLink.onclick = function() {
            return confirm(`Delete unit ${unit.name}?`);
        };
        deleteLink.innerHTML = '<i class="fa-solid fa-trash"></i>';

        row.appendChild(optionButton);
        row.appendChild(editButton);
        row.appendChild(deleteLink);

        return row;
    }

    function insertUnitOptionSorted(select, unit) {
        const option = document.createElement('option');
        option.value = unit.id;
        option.textContent = unit.name;

        const options = Array.from(select.options);
        const insertIndex = options.findIndex((existing) => {
            return existing.text.toLowerCase() > unit.name.toLowerCase();
        });

        if (insertIndex === -1) {
            select.add(option);
        } else {
            select.add(option, options[insertIndex]);
        }
    }

    function insertUnitItemSorted(list, unit, deleteUrlTemplate) {
        const item = createUnitItem(unit, deleteUrlTemplate);
        const items = Array.from(list.querySelectorAll('.unit-dropdown-item'));
        const insertIndex = items.findIndex((existing) => {
            const label = existing.querySelector('[data-unit-option]')?.textContent || '';
            return label.toLowerCase() > unit.name.toLowerCase();
        });

        if (insertIndex === -1) {
            list.appendChild(item);
        } else {
            list.insertBefore(item, items[insertIndex]);
        }
    }

    function ensureUnitIcon(button, iconClass) {
        if (!button) return;
        button.innerHTML = '';
        const icon = document.createElement('i');
        icon.className = `fa-solid ${iconClass}`;
        button.appendChild(icon);
    }

    function addUnitToDropdowns(unit) {
        document.querySelectorAll('[data-unit-dropdown]').forEach((container) => {
            const select = container.querySelector('select');
            const list = container.querySelector('.unit-dropdown-list');
            if (select) insertUnitOptionSorted(select, unit);
            if (list) insertUnitItemSorted(list, unit, list.dataset.deleteUrlTemplate || '');
            sortUnitDropdown(container);
            updateUnitDropdownLabel(container);
        });
    }

    function updateUnitInDropdowns(unit) {
        document.querySelectorAll('[data-unit-dropdown]').forEach((container) => {
            const select = container.querySelector('select');
            if (select) {
                const option = Array.from(select.options).find((opt) => opt.value === String(unit.id));
                if (option) option.textContent = unit.name;
            }

            const list = container.querySelector('.unit-dropdown-list');
            const optionButton = list?.querySelector(`[data-unit-option][data-unit-id="${unit.id}"]`);
            const editButton = list?.querySelector(`[data-unit-edit][data-unit-id="${unit.id}"]`);
            if (optionButton) {
                optionButton.textContent = unit.name;
                optionButton.dataset.unitName = unit.name;
            }
            if (editButton) {
                editButton.title = `Edit ${unit.name}`;
                editButton.dataset.unitName = unit.name;
                ensureUnitIcon(editButton, 'fa-pen-to-square');
            }
            const deleteLink = list?.querySelector(`a[href*="/${unit.id}/"]`);
            if (deleteLink) {
                deleteLink.title = `Delete ${unit.name}`;
                ensureUnitIcon(deleteLink, 'fa-trash');
            }

            sortUnitDropdown(container);
            updateUnitDropdownLabel(container);
        });
    }

    function removeUnitFromDropdowns(unitId) {
        document.querySelectorAll('[data-unit-dropdown]').forEach((container) => {
            const select = container.querySelector('select');
            if (select) {
                const option = Array.from(select.options).find((opt) => opt.value === String(unitId));
                if (option) {
                    const wasSelected = option.selected;
                    option.remove();
                    if (wasSelected) {
                        select.selectedIndex = 0;
                    }
                }
            }

            const list = container.querySelector('.unit-dropdown-list');
            const optionButton = list?.querySelector(`[data-unit-option][data-unit-id="${unitId}"]`);
            const item = optionButton?.closest('.unit-dropdown-item');
            if (item) item.remove();

            updateUnitDropdownLabel(container);
        });
    }

    function updateIngredientsUnitDisplay(unitId, unitName) {
        document.querySelectorAll(`[data-unit-id="${unitId}"]`).forEach((cell) => {
            cell.textContent = unitName;
        });
    }

    function sortUnitDropdown(container) {
        const select = container.querySelector('select');
        const list = container.querySelector('.unit-dropdown-list');

        if (select) {
            const options = Array.from(select.options);
            options.sort((a, b) => a.text.toLowerCase().localeCompare(b.text.toLowerCase()));
            select.innerHTML = '';
            options.forEach((option) => select.add(option));
        }

        if (list) {
            const items = Array.from(list.querySelectorAll('.unit-dropdown-item'));
            items.sort((a, b) => {
                const aLabel = a.querySelector('[data-unit-option]')?.textContent || '';
                const bLabel = b.querySelector('[data-unit-option]')?.textContent || '';
                return aLabel.toLowerCase().localeCompare(bLabel.toLowerCase());
            });
            items.forEach((item) => list.appendChild(item));

            items.forEach((item) => {
                const editButton = item.querySelector('[data-unit-edit]');
                const deleteButton = item.querySelector('[data-unit-delete]');
                ensureUnitIcon(editButton, 'fa-pen-to-square');
                ensureUnitIcon(deleteButton, 'fa-trash');
            });
        }
    }

    function initUnitDropdown(container) {
        const button = container.querySelector('[data-unit-dropdown-button]');
        const menu = container.querySelector('[data-unit-dropdown-menu]');
        const select = container.querySelector('select');
        if (!button || !menu || !select) return;

        updateUnitDropdownLabel(container);

        button.addEventListener('click', function() {
            sortUnitDropdown(container);
            menu.classList.toggle('hidden');
        });

        container.addEventListener('click', function(event) {
            const optionButton = event.target.closest('[data-unit-option]');
            const editButton = event.target.closest('[data-unit-edit]');
            const addButton = event.target.closest('[data-unit-add]');
            const deleteLink = event.target.closest('[data-unit-delete]');

            if (addButton) {
                menu.classList.add('hidden');
                openUnitAdd(container);
                return;
            }

            if (editButton) {
                menu.classList.add('hidden');
                openUnitEdit(editButton.dataset.unitId, editButton.dataset.unitName);
                return;
            }

            if (optionButton) {
                select.value = optionButton.dataset.unitId || '';
                updateUnitDropdownLabel(container);
                menu.classList.add('hidden');
            }

            if (deleteLink) {
                event.preventDefault();
                menu.classList.add('hidden');
                openUnitDeleteConfirm(container, deleteLink.getAttribute('href'), deleteLink.dataset.unitName || '');
            }
        });

        document.addEventListener('click', function(event) {
            if (!container.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-unit-dropdown]').forEach(initUnitDropdown);

        const addCurrencyInput = document.querySelector('#modal-ingredient [name$="cost_per_unit_1"]');
        if (addCurrencyInput) {
            addCurrencyInput.value = 'USD';
        }

        const unitAddForm = document.getElementById('unit-add-form');
        if (unitAddForm) {
            unitAddForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formData = new FormData(unitAddForm);
                const response = await fetch(unitAddForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                    },
                    body: formData,
                });

                if (response.ok) {
                    const unit = await response.json();
                    addUnitToDropdowns(unit);
                    if (activeUnitDropdown) {
                        const select = activeUnitDropdown.querySelector('select');
                        if (select) {
                            select.value = String(unit.id);
                        }
                        updateUnitDropdownLabel(activeUnitDropdown);
                    }
                    document.getElementById('modal-unit-add').close();
                } else {
                    const data = await response.json();
                    alert('Unable to add unit. ' + JSON.stringify(data.errors || {}));
                }
            });
        }

        const unitEditForm = document.getElementById('unit-edit-form');
        if (unitEditForm) {
            unitEditForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const formData = new FormData(unitEditForm);
                const response = await fetch(unitEditForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                    },
                    body: formData,
                });

                if (response.ok) {
                    const unit = await response.json();
                    updateUnitInDropdowns(unit);
                    document.getElementById('modal-unit-edit').close();
                } else {
                    const data = await response.json();
                    alert('Unable to update unit. ' + JSON.stringify(data.errors || {}));
                }
            });
        }
    });

    function openUnitDeleteConfirm(container, deleteUrl, unitName) {
        const modal = container.closest('dialog');
        const confirmBox = modal?.querySelector('[data-unit-delete-confirm-box]');
        const textEl = modal?.querySelector('[data-unit-delete-text]');
        if (!confirmBox || !textEl) return;

        confirmBox.dataset.deleteUrl = deleteUrl;
        confirmBox.dataset.unitId = deleteUrl?.match(/\/(\d+)\/?$/)?.[1] || '';
        textEl.textContent = `Delete unit ${unitName}?`;
        confirmBox.classList.remove('hidden');
    }

    document.addEventListener('click', function(event) {
        const ingredientDelete = event.target.closest('[data-ingredient-delete]');
        if (ingredientDelete) {
            event.preventDefault();
            openIngredientDeleteConfirm(ingredientDelete);
            return;
        }

        const ingredientCancel = event.target.closest('[data-ingredient-delete-cancel]');
        if (ingredientCancel) {
            const box = ingredientCancel.closest('[data-ingredient-delete-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        const ingredientConfirm = event.target.closest('[data-ingredient-delete-confirm]');
        if (ingredientConfirm) {
            const box = ingredientConfirm.closest('[data-ingredient-delete-confirm-box]');
            const deleteUrl = box?.dataset.deleteUrl;
            if (deleteUrl) {
                window.location.href = deleteUrl;
            }
            return;
        }

        const recipeDelete = event.target.closest('[data-recipe-delete]');
        if (recipeDelete) {
            event.preventDefault();
            openRecipeDeleteConfirm(recipeDelete);
            return;
        }

        const recipeCancel = event.target.closest('[data-recipe-delete-cancel]');
        if (recipeCancel) {
            const box = recipeCancel.closest('[data-recipe-delete-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        const recipeConfirm = event.target.closest('[data-recipe-delete-confirm]');
        if (recipeConfirm) {
            const box = recipeConfirm.closest('[data-recipe-delete-confirm-box]');
            const deleteUrl = box?.dataset.deleteUrl;
            if (deleteUrl) {
                window.location.href = deleteUrl;
            }
            return;
        }

        const mealDelete = event.target.closest('[data-meal-delete]');
        if (mealDelete) {
            event.preventDefault();
            openMealDeleteConfirm(mealDelete);
            return;
        }

        const mealCancel = event.target.closest('[data-meal-delete-cancel]');
        if (mealCancel) {
            const box = mealCancel.closest('[data-meal-delete-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        const mealConfirm = event.target.closest('[data-meal-delete-confirm]');
        if (mealConfirm) {
            const box = mealConfirm.closest('[data-meal-delete-confirm-box]');
            const deleteUrl = box?.dataset.deleteUrl;
            if (deleteUrl) {
                window.location.href = deleteUrl;
            }
            return;
        }

        const menuDelete = event.target.closest('[data-menu-delete]');
        if (menuDelete) {
            event.preventDefault();
            openMenuDeleteConfirm(menuDelete);
            return;
        }

        const menuCancel = event.target.closest('[data-menu-delete-cancel]');
        if (menuCancel) {
            const box = menuCancel.closest('[data-menu-delete-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        const menuConfirm = event.target.closest('[data-menu-delete-confirm]');
        if (menuConfirm) {
            const box = menuConfirm.closest('[data-menu-delete-confirm-box]');
            const deleteUrl = box?.dataset.deleteUrl;
            if (deleteUrl) {
                window.location.href = deleteUrl;
            }
            return;
        }

        const cancelBtn = event.target.closest('[data-unit-delete-cancel]');
        const confirmBtn = event.target.closest('[data-unit-delete-confirm]');
        if (cancelBtn) {
            const box = cancelBtn.closest('[data-unit-delete-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        if (confirmBtn) {
            const box = confirmBtn.closest('[data-unit-delete-confirm-box]');
            const deleteUrl = box?.dataset.deleteUrl;
            const unitId = box?.dataset.unitId;
            if (deleteUrl) {
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                }).then(async (response) => {
                    if (response.ok) {
                        if (unitId) {
                            removeUnitFromDropdowns(unitId);
                        }
                        box.classList.add('hidden');
                    } else {
                        const data = await response.json();
                        if (data.error === 'Unit is in use.') {
                            box.classList.add('hidden');
                            openUnitRenameConfirm(box.closest('dialog'), unitId);
                        } else {
                            alert(data.error || 'Unable to delete unit.');
                        }
                    }
                });
            }
        }

        const renameCancel = event.target.closest('[data-unit-rename-cancel]');
        if (renameCancel) {
            const box = renameCancel.closest('[data-unit-rename-confirm-box]');
            if (box) box.classList.add('hidden');
            return;
        }

        const renameConfirm = event.target.closest('[data-unit-rename-confirm]');
        if (renameConfirm) {
            const box = renameConfirm.closest('[data-unit-rename-confirm-box]');
            const unitId = box?.dataset.unitId;
            const input = box?.querySelector('input');
            const newName = input?.value?.trim();
            if (!unitId || !newName) return;

            fetch("{% url 'edit_ingredient_unit' 0 %}".replace('0', unitId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: new URLSearchParams({
                    '{{ edit_unit_form.name.html_name }}': newName,
                }),
            }).then(async (response) => {
                if (response.ok) {
                    const unit = await response.json();
                    updateUnitInDropdowns(unit);
                    updateIngredientsUnitDisplay(unit.id, unit.name);
                    box.classList.add('hidden');
                } else {
                    const data = await response.json();
                    alert('Unable to rename unit. ' + JSON.stringify(data.errors || {}));
                }
            });
        }
    });

    function openUnitRenameConfirm(modal, unitId) {
        const box = modal?.querySelector('[data-unit-rename-confirm-box]');
        const textEl = modal?.querySelector('[data-unit-rename-text]');
        const input = box?.querySelector('input');
        if (!box || !textEl || !input) return;

        box.dataset.unitId = unitId || '';
        textEl.textContent = 'This unit is in use. Rename it to keep existing ingredients updated.';
        input.value = '';
        box.classList.remove('hidden');
        input.focus();
    }
</script>
{% endblock %}