{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-end mb-8 border-b-2 border-brand-teal/20 pb-4 gap-4">
    <div>
        <h1 class="text-4xl font-bold text-brand-dark tracking-tight">Chef's Dashboard</h1>
        <p class="text-gray-500 mt-1">Manage pantry, recipes, and the weekly drop.</p>
    </div>
    <div class="text-right">
        <span class="block text-xs uppercase tracking-wider text-gray-400 font-bold mb-1">Current Status</span>
        {% if active_week %}
            <span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold bg-green-100 text-green-800 shadow-sm border border-green-200">
                <span class="w-2.5 h-2.5 bg-green-500 rounded-full mr-2 animate-pulse"></span> Kitchen Open
            </span>
        {% else %}
            <span class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold bg-red-100 text-red-800 shadow-sm border border-red-200">
                <span class="w-2.5 h-2.5 bg-red-500 rounded-full mr-2"></span> Kitchen Closed
            </span>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full">
        <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
            <h3 class="text-brand-light font-bold text-lg tracking-wide"><i class="fa-solid fa-box-open mr-2 text-brand-teal"></i> Ingredients</h3>
            <button onclick="document.getElementById('modal-ingredient').showModal()" 
                    class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
                + Add New
            </button>
        </div>
        <div class="p-0 overflow-x-auto flex-grow">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Name</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">In Stock</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Unit</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Cost / Unit</th>
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for ing in ingredients %}
                    <tr class="hover:bg-brand-light/50 transition group">
                        <td class="px-6 py-3 font-medium text-brand-dark group-hover:text-brand-teal transition-colors">
                            <button type="button"
                                    class="text-left hover:underline"
                                    data-edit-url="{% url 'edit_ingredient' ing.id %}"
                                    data-name="{{ ing.name|escapejs }}"
                                    data-quantity="{{ ing.quantity }}"
                                    data-unit-type="{{ ing.unit_type }}"
                                    data-unit-custom="{{ ing.unit_custom|default_if_none:''|escapejs }}"
                                    data-cost-amount="{{ ing.cost_per_unit.amount }}"
                                    data-cost-currency="{{ ing.cost_per_unit.currency }}"
                                    onclick="openIngredientEdit(this)">
                                {{ ing.name }}
                            </button>
                        </td>
                        <td class="px-6 py-3 font-mono text-gray-700">
                            {{ ing.quantity }}
                        </td>
                        <td class="px-6 py-3 font-mono text-gray-700">
                            {{ ing.unit_display }}
                        </td>
                        <td class="px-6 py-3 text-right text-gray-600 font-mono">
                            {{ ing.cost_per_unit }}
                        </td>
                        <td class="px-6 py-3 text-right space-x-3">
                            <button type="button"
                                    class="text-gray-400 hover:text-brand-teal transition"
                                    title="Edit"
                                    data-edit-url="{% url 'edit_ingredient' ing.id %}"
                                    data-name="{{ ing.name|escapejs }}"
                                    data-quantity="{{ ing.quantity }}"
                                    data-unit-type="{{ ing.unit_type }}"
                                    data-unit-custom="{{ ing.unit_custom|default_if_none:''|escapejs }}"
                                    data-cost-amount="{{ ing.cost_per_unit.amount }}"
                                    data-cost-currency="{{ ing.cost_per_unit.currency }}"
                                    onclick="openIngredientEdit(this)">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <a href="{% url 'delete_ingredient' ing.id %}"
                               class="text-gray-400 hover:text-red-500 transition"
                               title="Delete"
                               onclick="return confirm('Delete {{ ing.name|escapejs }}?')">
                                <i class="fa-solid fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">Pantry is empty.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full">
        <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
            <h3 class="text-brand-light font-bold text-lg tracking-wide"><i class="fa-solid fa-book-open mr-2 text-brand-teal"></i> Recipes</h3>
            <a href="{% url 'add_recipe' %}" class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
                + Build Recipe
            </a>
        </div>
        <div class="p-0 flex-grow">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Dish</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Ingredients</th>
                        <th class="px-6 py-3 font-semibold text-brand-teal">Base Cost</th>
                        <th class="px-6 py-3 text-center font-semibold text-brand-teal">Details</th> 
                        <th class="px-6 py-3 text-right font-semibold text-brand-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for recipe in recipes %}
                    <tr class="hover:bg-brand-light/50 transition">
                        <td class="px-6 py-3 font-medium text-brand-dark">
                            <a href="{% url 'edit_recipe' recipe.id %}" class="hover:text-brand-teal hover:underline transition">
                                {{ recipe.name }}
                            </a>
                        </td>
                        <td class="px-6 py-3 text-gray-600 text-xs max-w-[260px]" title="{% for ri in recipe.recipe_ingredients.all %}{{ ri.ingredient.name }} ({{ ri.quantity }} {{ ri.ingredient.unit_display }}){% if not forloop.last %}, {% endif %}{% endfor %}">
                            {% with total=recipe.recipe_ingredients.count %}
                                {% for ri in recipe.recipe_ingredients.all|slice:":3" %}
                                    <span class="inline-block bg-gray-50 border border-gray-200 rounded-full px-2 py-0.5 mr-1 mb-1">
                                        {{ ri.ingredient.name }} ({{ ri.quantity }} {{ ri.ingredient.unit_display }})
                                    </span>
                                {% endfor %}
                                {% if total > 3 %}
                                    <span class="inline-block text-gray-400 text-[10px] font-semibold uppercase tracking-wide align-middle">
                                        +{{ total|add:"-3" }} more
                                    </span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-6 py-3 text-gray-600 font-mono">{{ recipe.calculate_cost }}</td>
                        
                        <td class="px-6 py-3 text-center">
                            {% if recipe.instructions %}
                                <button onclick="openInstructionsModal('{{ recipe.name|escapejs }}', '{{ recipe.instructions|escapejs }}', '{% for ri in recipe.recipe_ingredients.all %}{{ ri.ingredient.name|escapejs }} ({{ ri.quantity }} {{ ri.ingredient.unit_display|escapejs }}){% if not forloop.last %}, {% endif %}{% endfor %}')" 
                                        class="text-xs bg-brand-light text-brand-teal border border-brand-teal px-3 py-1 rounded-full hover:bg-brand-teal hover:text-white transition font-bold">
                                    View Ingredients &amp; Instructions
                                </button>
                            {% else %}
                                <span class="text-xs text-gray-300 italic">No text</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-3 text-right space-x-3">
                            <a href="{% url 'edit_recipe' recipe.id %}" class="text-gray-400 hover:text-brand-teal transition" title="Edit"><i class="fa-solid fa-pen-to-square"></i></a>
                            <a href="{% url 'delete_recipe' recipe.id %}" class="text-gray-400 hover:text-red-500 transition" onclick="return confirm('Delete {{ recipe.name }}?')" title="Delete"><i class="fa-solid fa-trash"></i></a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">No recipes created yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col h-full mt-8 lg:mt-0 lg:col-span-2">
    <div class="bg-brand-dark p-5 flex justify-between items-center border-b-4 border-brand-teal">
        <h3 class="text-brand-light font-bold text-lg tracking-wide"><i class="fa-solid fa-utensils mr-2 text-brand-teal"></i> Meals</h3>
        <a href="{% url 'add_meal' %}" class="bg-brand-teal text-brand-dark hover:bg-white hover:text-brand-dark text-xs uppercase tracking-wider px-3 py-2 rounded font-bold transition shadow-md">
            + Build Meal
        </a>
    </div>
    <div class="p-0 flex-grow">
        <table class="w-full text-left text-sm">
            <thead class="bg-gray-50 text-gray-500 uppercase tracking-wider text-xs">
                <tr>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Meal Name</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Base Cost</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Price</th>
                    <th class="px-6 py-3 font-semibold text-brand-teal">Profit</th>
                    <th class="px-6 py-3 text-center font-semibold text-brand-teal">Details</th>
                    <th class="px-6 py-3 text-center font-semibold text-brand-teal">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for meal in meals %}
                <tr class="hover:bg-brand-light/50 transition group">
                    <td class="px-6 py-4 font-medium text-brand-dark align-middle">{{ meal.name }}</td>
                    <td class="px-6 py-4 text-gray-600 font-mono align-middle">{{ meal.calculate_cost }}</td>
                    
                    <td class="px-6 py-4 font-bold text-brand-dark font-mono align-middle">
                        {% if meal.customer_price %}
                            {{ meal.customer_price }}
                        {% else %}
                            <span class="text-gray-300 text-xs">--</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 font-mono font-bold align-middle">
                        {% if meal.projected_profit.amount < 0 %}
                            <span class="text-red-500">
                                (${{ meal.projected_profit.amount|stringformat:".2f"|cut:"-" }})
                            </span>
                        {% else %}
                            <span class="text-green-600">
                                {{ meal.projected_profit }}
                            </span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-center align-middle">
                        {% if meal.description %}
                            <button onclick="openInstructionsModal('{{ meal.name|escapejs }}', '{{ meal.description|escapejs }}')" 
                                    class="text-xs bg-brand-light text-brand-teal border border-brand-teal px-3 py-1 rounded-full hover:bg-brand-teal hover:text-white transition font-bold shadow-sm">
                                View Description
                            </button>
                        {% else %}
                            <span class="text-xs text-gray-300 italic">No notes</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-center align-middle space-x-3">
                        <a href="{% url 'edit_meal' meal.id %}" class="text-gray-400 hover:text-brand-teal transition inline-block"><i class="fa-solid fa-pen-to-square fa-lg"></i></a>
                        <a href="{% url 'delete_meal' meal.id %}" class="text-gray-400 hover:text-red-500 transition inline-block" onclick="return confirm('Delete Meal?')"><i class="fa-solid fa-trash fa-lg"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="px-6 py-8 text-center text-gray-400 italic">No meals created yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-brand-dark to-[#0f2e3d] p-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h3 class="text-brand-light font-bold text-xl tracking-wide flex items-center">
                    <i class="fa-solid fa-calendar-week mr-3 text-brand-teal"></i> 
                    Active Drop
                </h3>
                <p class="text-brand-teal/80 text-sm mt-1 font-mono uppercase tracking-widest">{{ active_week.name|default:"NO ACTIVE DROP SCHEDULED" }}</p>
            </div>
            {% if active_week %}
                <button onclick="document.getElementById('modal-menu-item').showModal()" 
                        class="bg-white text-brand-dark hover:bg-brand-teal hover:text-white px-6 py-2.5 rounded-lg font-bold shadow-lg transition transform hover:-translate-y-0.5">
                    + Add Dish to Drop
                </button>
            {% else %}
                <a href="/admin/store/menuweek/add/" class="text-brand-teal underline hover:text-white transition text-sm">Create Week in Admin Panel &rarr;</a>
            {% endif %}
        </div>
        
        {% if active_week and menu_items %}
        <div class="p-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 bg-brand-light/20">
            {% for item in menu_items %}
            <div class="bg-white border border-gray-100 rounded-xl p-5 shadow-sm hover:shadow-md transition relative group">
                <div class="absolute top-0 left-0 w-1 h-full bg-brand-teal rounded-l-xl opacity-0 group-hover:opacity-100 transition"></div>
                
                <div class="flex justify-between items-start mb-3">
                    <h4 class="font-bold text-brand-dark text-lg leading-tight">{{ item.recipe.name }}</h4>
                </div>
                
                <div class="space-y-1 mb-4">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Base Cost:</span>
                        <span class="font-mono">{{ item.recipe.calculate_cost }}</span>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-50 flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Selling Price</p>
                        <p class="text-2xl font-bold text-brand-dark">{{ item.selling_price }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider font-bold">Profit</p>
                        <p class="text-lg font-bold text-green-600 font-mono">+{{ item.projected_profit }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% elif active_week %}
             <div class="p-12 text-center text-gray-400">
                <i class="fa-solid fa-plate-wheat text-4xl mb-3 text-gray-200"></i>
                <p>No dishes added to this drop yet.</p>
             </div>
        {% endif %}
    </div>
</div>

<dialog id="modal-ingredient" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Add Ingredient</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" action="{% url 'add_ingredient' %}" class="p-6 bg-white">
        {% csrf_token %}
        {% if ingredient_form.non_field_errors %}
            <div class="mb-4 text-sm text-red-600">
                {{ ingredient_form.non_field_errors }}
            </div>
        {% endif %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.name.id_for_label }}">Name</label>
                {{ ingredient_form.name }}
                {{ ingredient_form.name.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.quantity.id_for_label }}">Quantity</label>
                {{ ingredient_form.quantity }}
                {{ ingredient_form.quantity.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.unit_type.id_for_label }}">Unit</label>
                {{ ingredient_form.unit_type }}
                {{ ingredient_form.unit_type.errors }}
            </div>
            <div id="unit-custom-field" class="hidden">
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.unit_custom.id_for_label }}">Custom Unit</label>
                {{ ingredient_form.unit_custom }}
                {{ ingredient_form.unit_custom.errors }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ ingredient_form.cost_per_unit.id_for_label }}">Cost per Unit</label>
                <div class="relative">
                    <i class="fa-solid fa-dollar-sign absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    {{ ingredient_form.cost_per_unit.subwidgets.0 }}
                </div>
                {{ ingredient_form.cost_per_unit.subwidgets.1 }}
                {{ ingredient_form.cost_per_unit.errors }}
            </div>
        </div>
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-6 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Save</button>
        </div>
    </form>
</dialog>

<dialog id="modal-ingredient-edit" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Edit Ingredient</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" id="ingredient-edit-form" class="p-6 bg-white">
        {% csrf_token %}
        <div class="grid grid-cols-1 gap-4">
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.name.id_for_label }}">Name</label>
                {{ edit_ingredient_form.name }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.quantity.id_for_label }}">Quantity</label>
                {{ edit_ingredient_form.quantity }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.unit_type.id_for_label }}">Unit</label>
                {{ edit_ingredient_form.unit_type }}
            </div>
            <div id="unit-custom-field-edit" class="hidden">
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.unit_custom.id_for_label }}">Custom Unit</label>
                {{ edit_ingredient_form.unit_custom }}
            </div>
            <div>
                <label class="block text-brand-dark font-bold mb-2" for="{{ edit_ingredient_form.cost_per_unit.id_for_label }}">Cost per Unit</label>
                <div class="relative">
                    <i class="fa-solid fa-dollar-sign absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    {{ edit_ingredient_form.cost_per_unit.subwidgets.0 }}
                </div>
                {{ edit_ingredient_form.cost_per_unit.subwidgets.1 }}
            </div>
        </div>
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-6 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Save</button>
        </div>
    </form>
</dialog>

<dialog id="modal-menu-item" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-md open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 class="text-white font-bold text-lg">Add to Menu</h3>
        <button onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white transition"><i class="fa-solid fa-xmark fa-lg"></i></button>
    </div>
    <form method="POST" action="{% url 'add_menu_item' %}" class="p-6 bg-white">
        {% csrf_token %}
        {{ menu_item_form.as_p }}
        <div class="mt-8 flex justify-end gap-3">
            <button type="button" onclick="this.closest('dialog').close()" class="px-5 py-2 text-gray-500 hover:bg-gray-50 rounded-lg font-medium transition">Cancel</button>
            <button type="submit" class="bg-brand-teal text-white px-6 py-2 rounded-lg font-bold hover:bg-brand-dark transition shadow-md">Add to Drop</button>
        </div>
    </form>
</dialog>

<dialog id="modal-instructions" class="p-0 rounded-xl shadow-2xl backdrop:bg-brand-dark/80 w-full max-w-lg open:animate-[fadeIn_0.2s_ease-out]">
    <div class="bg-brand-dark p-5 border-b border-gray-700 flex justify-between items-center">
        <h3 id="modal-instructions-title" class="text-white font-bold text-lg">Recipe Name</h3>
        <button onclick="document.getElementById('modal-instructions').close()" class="text-gray-400 hover:text-white transition">
            <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
    </div>
    <div class="p-8 bg-white">
        <div class="mb-6">
            <h4 class="text-xs uppercase tracking-wider text-brand-teal font-bold mb-2">Ingredients</h4>
            <ul id="modal-instructions-ingredients" class="text-gray-600 text-sm list-disc pl-5"></ul>
        </div>
        <div class="mb-2">
            <h4 class="text-xs uppercase tracking-wider text-brand-teal font-bold">Instructions</h4>
        </div>
        <div class="prose prose-sm max-w-none text-gray-600 leading-relaxed">
            <p id="modal-instructions-text" class="whitespace-pre-wrap"></p>
        </div>
        <div class="mt-8 flex justify-end">
            <button onclick="document.getElementById('modal-instructions').close()" class="bg-gray-100 text-gray-600 px-6 py-2 rounded-lg font-bold hover:bg-gray-200 transition">
                Close
            </button>
        </div>
    </div>
</dialog>

<script>
    function toggleCustomUnitField(selectId, fieldId) {
        const unitSelect = document.getElementById(selectId);
        const customField = document.getElementById(fieldId);
        if (!unitSelect || !customField) return;

        const isOther = unitSelect.value === 'OTHER';
        customField.classList.toggle('hidden', !isOther);
    }

    function openIngredientEdit(trigger) {
        const modal = document.getElementById('modal-ingredient-edit');
        const form = document.getElementById('ingredient-edit-form');

        if (!modal || !form) return;

        form.action = trigger.dataset.editUrl;
        document.getElementById('{{ edit_ingredient_form.name.id_for_label }}').value = trigger.dataset.name || '';
        document.getElementById('{{ edit_ingredient_form.quantity.id_for_label }}').value = trigger.dataset.quantity || '';
        document.getElementById('{{ edit_ingredient_form.unit_type.id_for_label }}').value = trigger.dataset.unitType || '';
        document.getElementById('{{ edit_ingredient_form.unit_custom.id_for_label }}').value = trigger.dataset.unitCustom || '';

        const amountInput = form.querySelector('input[name$="cost_per_unit_0"]');
        const currencyInput = form.querySelector('[name$="cost_per_unit_1"]');
        if (amountInput) amountInput.value = trigger.dataset.costAmount || '';
        if (currencyInput) currencyInput.value = trigger.dataset.costCurrency || 'USD';

        toggleCustomUnitField('{{ edit_ingredient_form.unit_type.id_for_label }}', 'unit-custom-field-edit');
        modal.showModal();
    }

    function openInstructionsModal(title, text, ingredients) {
        const modal = document.getElementById('modal-instructions');
        const titleEl = document.getElementById('modal-instructions-title');
        const textEl = document.getElementById('modal-instructions-text');
        const ingredientsEl = document.getElementById('modal-instructions-ingredients');
        
        // Inject content
        titleEl.textContent = title;
        textEl.textContent = text;
        ingredientsEl.innerHTML = '';
        if (ingredients) {
            ingredients.split(',').forEach(function(item) {
                const text = item.trim();
                if (!text) return;
                const li = document.createElement('li');
                li.textContent = text;
                ingredientsEl.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No ingredients listed.';
            ingredientsEl.appendChild(li);
        }
        
        // Open modal
        modal.showModal();
    }

    document.addEventListener('DOMContentLoaded', function() {
        toggleCustomUnitField('{{ ingredient_form.unit_type.id_for_label }}', 'unit-custom-field');
        const unitSelect = document.getElementById('{{ ingredient_form.unit_type.id_for_label }}');
        if (unitSelect) {
            unitSelect.addEventListener('change', function() {
                toggleCustomUnitField('{{ ingredient_form.unit_type.id_for_label }}', 'unit-custom-field');
            });
        }

        const addCurrencyInput = document.querySelector('#modal-ingredient [name$="cost_per_unit_1"]');
        if (addCurrencyInput) {
            addCurrencyInput.value = 'USD';
        }

        const editUnitSelect = document.getElementById('{{ edit_ingredient_form.unit_type.id_for_label }}');
        if (editUnitSelect) {
            editUnitSelect.addEventListener('change', function() {
                toggleCustomUnitField('{{ edit_ingredient_form.unit_type.id_for_label }}', 'unit-custom-field-edit');
            });
        }
    });
</script>
{% endblock %}